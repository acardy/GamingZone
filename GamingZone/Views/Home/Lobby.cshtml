@model GamingZone.Models.Lobby

@{
    ViewBag.Title = "Lobby";
}

@section CSS{
    <link href="~/Content/Lobby.css" rel="stylesheet" />
}

<h2>@Model.Name</h2>

<p>Welcome to the @Model.Name lobby</p>

<div class="container">

    <div class="lobby-tables-content">
        <div class="lobby-container">

            @* Header *@
            <div class="lobby-row">
                <div class="lobby-cell">Table</div>
                @for (int seatIndex = 0; seatIndex < @Model.SeatsPerTable; seatIndex++)
                {
                    <div class="lobby-cell"><Span>Player @(seatIndex + 1)</Span></div>
                }
                <div class="lobby-cell">Watch</div>
            </div>

            @* Rows *@
            @for (int tableIndex = 0; tableIndex < Model.Tables; tableIndex++)
            {
                <div class="lobby-row">
                    <div class="lobby-cell">@(tableIndex + 1)</div>
                    @for (int seatIndex = 0; seatIndex < @Model.SeatsPerTable; seatIndex++)
                    {
                        <div class="lobby-cell seat" data-table-index="@tableIndex" data-seat-index="@seatIndex">
                            <a href="#" class="seat-join-button">Join</a>
                            <span class="seat-user-name hidden"></span>
                            <Span class="seat-stand-button hidden">❎</Span>
                            <Span class="seat-accept-thumb hidden">👍</Span>
</div>
                    }
                    <div class="lobby-cell">Watch</div>
                </div>
            }
        </div>

    </div>

    <div class="lobby-container">

        <div class="lobby-row">
            <div class="lobby-cell" id="discussion"></div>
            <div class="lobby-cell" id="users"></div>
        </div>

    </div>

    <input type="text" id="message" />
    <input type="hidden" id="displayname" />

</div>

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {

            // Base lobby functionality
            $(".seat-accept-thumb").click(function(e)
            {
                $(this).toggleClass("accepted");
            });

            // Reference the auto-generated proxy for the hub.
            var lobby = $.connection.lobbyHub;

            lobby.state.lobbyId = @Model.Id;

            $('#discussion').empty();
            $('#message').focus();

            // Add events
            lobby.client.messageAdded = function (name, message) {
                $('#discussion').append('<div><strong>' + htmlEncode(name)
                    + '</strong>: ' + htmlEncode(message) + '</div>');
            };

            lobby.client.userJoined = function (name, allUsers) {
                $('#discussion').append('<div> ** User ' + htmlEncode(name) + ' has joined.</div>');
                $("#users").empty();
                $.each(allUsers, function(index, value){
                    $("#users").append("<div>"+value+"</div>");
                })
            };

            lobby.client.userLeft = function (name, allUsers) {
                $('#discussion').append('<div> ** User ' + htmlEncode(name) + ' has left.</div>');
                $("#users").empty();
                $.each(allUsers, function(index, value){
                    $("#users").append("<div>"+value+"</div>");
                })
            };

            lobby.client.seatUpdated = function (tableIndex, seatIndex, user, thumbUp) {
                var seat = $(".lobby-cell.seat")
                    .filter("*[data-table-index='"+tableIndex+"']")
                    .filter("*[data-seat-index='"+seatIndex+"']");

                if (thumbUp)
                    seat.children("seat-accept-thumb").addClass("accepted");
                else
                    seat.children("seat-accept-thumb").removeClass("accepted");

                if (user = null)
                {
                    seat.children(".seat-join-button").removeClass("hidden");
                    seat.children(".seat-user-name").addClass("hidden").text("");
                    seat.children("seat-accept-thumb").addClass("hidden");
                    seat.children("seat-stand-button").addClass("hidden");
                }
                else
                {
                    seat.children(".seat-join-button").addClass("hidden");
                    seat.children(".seat-user-name").removeClass("hidden").text(user);
                    seat.children("seat-accept-thumb").removeClass("hidden");
                    seat.children("seat-stand-button").removeClass("hidden");
                }
            };

            // Start the connection.
            $.connection.hub.logging = true;
            $.connection.hub.start().done(function () {

                // Table events
                $(".seat-join-button").click(function(e){                  
                    var tableIndex = $(e.target).parent().data("table-index");
                    var seatIndex = $(e.target).parent().data("seat-index");
                    lobby.server.selectSeat(tableIndex, seatIndex);
                    return false;
                })
                $(".seat-stand-button").click(function(e){                  
                    var tableIndex = $(e.target).parent().data("table-index");
                    var seatIndex = $(e.target).parent().data("seat-index");
                    lobby.server.exitSeat(tableIndex, seatIndex);
                    return false;
                })

                // Get the user name and store it to prepend to messages.
                $('#displayname').val(prompt('Enter your name:', ''));

                // Set the user name and join
                lobby.state.userName = $('#displayname').val();
                lobby.server.join();

                $('#message').keypress(function (e) {
                    if (e.which == 13) {
                        lobby.server.sendMessage($('#message').val());
                        $('#message').val('').focus();
                        return false;
                    }
                });
            });
        });

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

    </script>
}
