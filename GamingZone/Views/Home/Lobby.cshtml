@model GamingZone.Models.Lobby

@{
    ViewBag.Title = "Lobby";
}

@section CSS{
    <link href="~/Content/Lobby.css" rel="stylesheet" />
}

<h2>@Model.Name</h2>

<p>Welcome to the @Model.Name lobby</p>

<div class="container">

    <div class="row">

        <div class="col-md-9 col-sm-9">
            <div class="panel panel-default">
                <div class="panel-heading">Lobby</div>
                <div class="panel-body lobby-body">
                    @{
                        var tablesLeft = Model.Tables;
                        while (tablesLeft > 3)
                        {
                            <div class="row">
                                @for (var tableRowIndex = 0; tableRowIndex < 3; tableRowIndex++)
                {
                                    <div class="col-md-4 col-sm-4">
                                        <div class="panel panel-default">
                                            <div class="badge top-left">@(Model.Tables - tablesLeft + 1)</div>
                                            <!--<div class="panel-heading">@(Model.Tables - tablesLeft + 1)</div>-->
                                            <div class="panel-body">
                                                @for (int seatIndex = 0; seatIndex < @Model.SeatsPerTable; seatIndex++)
                                                {
                                                    <span class="lobby-cell seat" data-table-index="@(Model.Tables - tablesLeft)" data-seat-index="@seatIndex">
                                                        <a href="#" class="seat-join-button btn btn-default">Join</a>
                                                        <span class="seat-user-name hidden"></span>
                                                        <Span class="seat-stand-button hidden">❌</Span>
                                                        <Span class="seat-accept-thumb hidden">👍</Span>
                                                    </span>
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    { tablesLeft--; }
                                }

                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-3 no-padding-left">
            <div class="panel panel-default">
                <div class="panel-heading">People</div>
                <div id="users" class="panel-body lobby-body"></div>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="col-md-12 col-sm-12">
            <div class="panel panel-default">
                <div class="panel-body">
                    <div id="discussion"></div>
                </div>
                <div class="panel-footer">
                    <input type="text" class="form-control" id="message" placeholder="Chat..." />
                </div>
            </div>
        </div>
    </div>

</div>

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {

            // Base lobby functionality
            $(".seat-accept-thumb").click(function(e)
            {
                $(this).toggleClass("accepted");
            });

            // Reference the auto-generated proxy for the hub.
            var lobby = $.connection.lobbyHub;

            lobby.state.lobbyId = @Model.Id;

            $('#discussion').empty();
            $('#message').focus();

            // Add events
            lobby.client.messageAdded = function (name, message) {
                $('#discussion').append('<div><strong>' + htmlEncode(name)
                    + '</strong>: ' + htmlEncode(message) + '</div>');
            };

            lobby.client.userJoined = function (name, allUsers) {
                $('#discussion').append('<div> ** User ' + htmlEncode(name) + ' has joined.</div>');
                $("#users").empty();
                $.each(allUsers, function(index, value){
                    $("#users").append("<div>"+value+"</div>");
                })
            };

            lobby.client.userLeft = function (name, allUsers) {
                $('#discussion').append('<div> ** User ' + htmlEncode(name) + ' has left.</div>');
                $("#users").empty();
                $.each(allUsers, function(index, value){
                    $("#users").append("<div>"+value+"</div>");
                })
            };

            lobby.client.seatUpdated = function (tableIndex, seatIndex, user, thumbUp) {
                var seat = $(".lobby-cell.seat")
                    .filter("*[data-table-index='"+tableIndex+"']")
                    .filter("*[data-seat-index='"+seatIndex+"']");

                if (thumbUp)
                    seat.children("seat-accept-thumb").addClass("accepted");
                else
                    seat.children("seat-accept-thumb").removeClass("accepted");

                if (user == null)
                {
                    seat.children(".seat-join-button").text("Join");
                    seat.children(".seat-accept-thumb").addClass("hidden");
                }
                else
                {
                    seat.children(".seat-join-button").text(user);
                    seat.children(".seat-accept-thumb").removeClass("hidden");
                }
            };

            // Start the connection.
            $.connection.hub.logging = true;
            $.connection.hub.start().done(function () {

                // Table events
                $(".seat-join-button").click(function(e){
                    if (!$(e.target).hasClass("occupied"))
                    {
                        $(e.target).addClass("occupied");
                        var tableIndex = $(e.target).parent().data("table-index");
                        var seatIndex = $(e.target).parent().data("seat-index");
                        lobby.server.selectSeat(tableIndex, seatIndex);
                        return false;
                    }
                    else{
                        $(e.target).removeClass("occupied");
                        var tableIndex = $(e.target).parent().data("table-index");
                        var seatIndex = $(e.target).parent().data("seat-index");
                        lobby.server.exitSeat(tableIndex, seatIndex);
                        return false;
                    }
                });

                // Set the user name and join
                lobby.server.join();

                $('#message').keypress(function (e) {
                    if (e.which == 13) {
                        lobby.server.sendMessage($('#message').val());
                        $('#message').val('').focus();
                        return false;
                    }
                });
            });
        });

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

    </script>
}
